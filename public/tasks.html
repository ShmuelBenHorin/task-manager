<!DOCTYPE html>
<html lang="he">
<head>
  <link rel="stylesheet" href="style.css">

  <meta charset="UTF-8">
  <title>×”××©×™××•×ª ×©×œ×™</title>
</head>
<body>
  <h2>×©×œ×•× ×•×‘×¨×•×š ×”×‘× ×œ×× ×”×œ ×”××©×™××•×ª</h2>

  <div>
    <input id="taskInput" placeholder="×›×ª×•×‘ ××©×™××” ×—×“×©×”">
    <button id="addBtn">×”×•×¡×£</button>
  </div>

  <h3>×”××©×™××•×ª ×©×œ×š:</h3>
  <ul id="taskList"></ul>

  <button id="logoutBtn">×”×ª× ×ª×§</button>

  <pre id="output"></pre>

  <script>
    window.onload = () => {
      const token = localStorage.getItem("token");
      const output = document.getElementById("output");

      if (!token) {
        output.textContent = "××™×Ÿ ×˜×•×§×Ÿ â€“ ×¢×œ×™×š ×œ×”×ª×—×‘×¨";
        window.location.href = "/login.html";
        return;
      }

      // ×§×™×©×•×¨ ×›×¤×ª×•×¨×™× ×œ×¤×•× ×§×¦×™×•×ª
      document.getElementById("addBtn").onclick = addTask;
      document.getElementById("logoutBtn").onclick = logout;

      loadTasks();

      async function loadTasks() {
        try {
          const res = await fetch("/tasks", {
            headers: {
              "Authorization": "Bearer " + token
            }
          });

          if (!res.ok) throw new Error("×©×’×™××” ×‘×¢×ª ×©×œ×™×¤×ª ×”××©×™××•×ª");

          const tasks = await res.json();
          const list = document.getElementById("taskList");
          list.innerHTML = "";
          tasks.forEach(task => {
            const li = document.createElement("li");
            li.textContent = task.title + " ";

            const editBtn = document.createElement("button");
            editBtn.textContent = "âœï¸";
            editBtn.onclick = () => editTask(task._id, task.title);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "ğŸ—‘ï¸";
            deleteBtn.onclick = () => deleteTask(task._id);

            li.appendChild(editBtn);
            li.appendChild(deleteBtn);
            list.appendChild(li);
          });
        } catch (err) {
          output.textContent = "×©×’×™××ª ×˜×¢×™× ×”: " + err.message;
        }
      }

      async function addTask() {
        const title = document.getElementById("taskInput").value;
        if (!title) return;

        try {
          const res = await fetch("/tasks", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ title })
          });

          if (!res.ok) throw new Error("×©×’×™××” ×‘×”×•×¡×¤×ª ××©×™××”");

          document.getElementById("taskInput").value = "";
          loadTasks();
        } catch (err) {
          output.textContent = "×©×’×™××ª ×”×•×¡×¤×”: " + err.message;
        }
      }

      async function deleteTask(id) {
        try {
          const res = await fetch(`/tasks/${id}`, {
            method: "DELETE",
            headers: {
              "Authorization": "Bearer " + token
            }
          });

          if (!res.ok) throw new Error("×©×’×™××” ×‘××—×™×§×ª ××©×™××”");

          loadTasks();
        } catch (err) {
          output.textContent = "×©×’×™××ª ××—×™×§×”: " + err.message;
        }
      }

      async function editTask(id, currentTitle) {
        const newTitle = prompt("×¢×¨×•×š ××ª ×”××©×™××”:", currentTitle);
        if (!newTitle || newTitle === currentTitle) return;

        try {
          const res = await fetch(`/tasks/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ title: newTitle })
          });

          if (!res.ok) throw new Error("×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××©×™××”");

          loadTasks();
        } catch (err) {
          output.textContent = "×©×’×™××ª ×¢×“×›×•×Ÿ: " + err.message;
        }
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }
    };
  </script>
</body>
</html>
